{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "16155990743071810482"
    }
  },
  "parameters": {
    "environmentName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "metadata": {
        "description": "Name of the environment used to generate a short unique hash for resources."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Primary location for all resources"
      }
    },
    "keyVaultLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy Key Vault"
      }
    },
    "cosmosLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy Cosmos DB"
      }
    },
    "containerRegistryLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy Container Registry"
      }
    },
    "storageLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy Storage Account"
      }
    },
    "functionsLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy Azure Functions"
      }
    },
    "principalId": {
      "type": "string",
      "defaultValue": "[deployer().objectId]",
      "metadata": {
        "description": "Id of the user or app to assign application roles"
      }
    },
    "apiImageName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "The image name for the API service"
      }
    },
    "openAIServiceName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the OpenAI service. Automatically generated if left blank"
      }
    },
    "cosmosAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Cosmos DB account. Automatically generated if left blank"
      }
    },
    "containerRegistryName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Container Registry. Automatically generated if left blank"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Storage Account. Automatically generated if left blank"
      }
    },
    "keyVaultName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Key Vault. Automatically generated if left blank"
      }
    },
    "containerAppsEnvName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Container Apps Environment. Automatically generated if left blank"
      }
    },
    "logAnalyticsName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Log Analytics Workspace. Automatically generated if left blank"
      }
    },
    "applicationInsightsName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Application Insights. Automatically generated if left blank"
      }
    },
    "gptDeploymentLocation": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location to deploy AI Services"
      }
    },
    "createOpenAI": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to create a new Azure OpenAI service or use existing"
      }
    },
    "existingOpenAIEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Azure OpenAI endpoint (if not creating new)"
      }
    },
    "existingOpenAIKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Existing Azure OpenAI API key (if not creating new)"
      }
    },
    "openAIApiVersion": {
      "type": "string",
      "defaultValue": "2025-01-01-preview",
      "metadata": {
        "description": "Azure OpenAI API version"
      }
    },
    "model": {
      "type": "string",
      "allowedValues": [
        "o3-mini;2025-01-31",
        "o4-mini;2025-04-16",
        "gpt-4o;2024-08-06",
        "gpt-4.1;2025-04-14",
        "gpt-5;2025-08-07",
        "gpt-5-mini;2025-08-07",
        "gpt-5-nano;2025-08-07"
      ],
      "metadata": {
        "description": "Azure OpenAI model name and version to deploy. See: https://learn.microsoft.com/en-us/azure/ai-foundry/openai/how-to/reasoning"
      }
    },
    "modelCapacity": {
      "type": "int",
      "metadata": {
        "description": "Tokens per minute capacity for the model. Units of 1000 (capacity = 100 means 100K tokens per minute)"
      }
    },
    "modelSku": {
      "type": "string",
      "allowedValues": [
        "DataZoneStandard",
        "Standard",
        "GlobalStandard"
      ],
      "metadata": {
        "description": "Specify the deployment type of the model. \"Standard\" & \"DataZoneStandard\" only allow data processing and data storage within the specified Azure geography. GPT5 only supports \"GlobalStandard\" as of now. Please be aware that this can lead to data storage and data processing outside of your azure region!"
      }
    },
    "enableEvaluatorAddon": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Summary Evaluator Addon deployment (deployed as an extra Azure Function app)"
      }
    },
    "dockerImageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Docker image tag for functions"
      }
    },
    "enableAcs": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to provision Azure Communication Services for email (requires Microsoft.Communication provider registration)"
      }
    },
    "emailEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether email communications features in the app are enabled (hides UI and disables sending when false)"
      }
    },
    "webBaseUrl": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Override the web base URL used by API to build links; defaults to deployed Static Web App URL"
      }
    },
    "emailFrom": {
      "type": "string",
      "defaultValue": "no-reply@haime.local",
      "metadata": {
        "description": "Default From address for outbound emails"
      }
    },
    "emailSmtpHost": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "SMTP host for outbound email (optional)"
      }
    },
    "emailSmtpPort": {
      "type": "int",
      "defaultValue": 587,
      "metadata": {
        "description": "SMTP port for outbound email"
      }
    },
    "emailSmtpUser": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "SMTP username (optional)"
      }
    },
    "emailSmtpPass": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "SMTP password (optional)"
      }
    },
    "emailSmtpUseSsl": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "SMTP SSL/TLS usage"
      }
    },
    "tagParam": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags for all AI resources created. JSON object"
      }
    }
  },
  "variables": {
    "azdTemplateId": "healthcare-ai-model-evaluator@0.0.1",
    "projectName": "healthcare-ai-model-evaluator",
    "openAIModelName": "[split(parameters('model'), ';')[0]]",
    "openAIModelVersion": "[split(parameters('model'), ';')[1]]",
    "tags": "[union(parameters('tagParam'), createObject('azd-env-name', parameters('environmentName'), 'azd-template-id', variables('azdTemplateId')))]",
    "deploymentName": "[format('{0}-{1}', variables('projectName'), uniqueString(deployment().name))]",
    "uniqueSuffix": "[substring(uniqueString(subscription().id, resourceGroup().name, parameters('environmentName')), 1, 3)]",
    "names": {
      "openai": "[if(not(empty(parameters('openAIServiceName'))), parameters('openAIServiceName'), format('openai-{0}', variables('uniqueSuffix')))]",
      "cosmos": "[if(not(empty(parameters('cosmosAccountName'))), parameters('cosmosAccountName'), format('cosmos-{0}', variables('uniqueSuffix')))]",
      "registry": "[if(not(empty(parameters('containerRegistryName'))), parameters('containerRegistryName'), format('cr{0}', variables('uniqueSuffix')))]",
      "storage": "[if(not(empty(parameters('storageAccountName'))), parameters('storageAccountName'), format('st{0}', variables('uniqueSuffix')))]",
      "keyVault": "[if(not(empty(parameters('keyVaultName'))), parameters('keyVaultName'), format('kv-{0}', variables('uniqueSuffix')))]",
      "containerAppsEnv": "[if(not(empty(parameters('containerAppsEnvName'))), parameters('containerAppsEnvName'), format('cae-{0}', variables('uniqueSuffix')))]",
      "logAnalytics": "[if(not(empty(parameters('logAnalyticsName'))), parameters('logAnalyticsName'), format('log-{0}', variables('uniqueSuffix')))]",
      "appInsights": "[if(not(empty(parameters('applicationInsightsName'))), parameters('applicationInsightsName'), format('appi-{0}', variables('uniqueSuffix')))]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-monitoring', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "logAnalyticsName": {
            "value": "[variables('names').logAnalytics]"
          },
          "applicationInsightsName": {
            "value": "[variables('names').appInsights]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15766597803181014492"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "logAnalyticsName": {
              "type": "string"
            },
            "applicationInsightsName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2021-12-01-preview",
              "name": "[parameters('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "searchVersion": 1,
                  "legacy": 0,
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              ]
            }
          ],
          "outputs": {
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "value": "[parameters('logAnalyticsName')]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "value": "[parameters('applicationInsightsName')]"
            },
            "applicationInsightsConnectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').ConnectionString]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-registry', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": "[if(empty(parameters('containerRegistryLocation')), createObject('value', parameters('location')), createObject('value', parameters('containerRegistryLocation')))]",
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[variables('names').registry]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "13673495020579763080"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "name": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2021-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": true
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2021-09-01').loginServer]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-keyvault', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": "[if(empty(parameters('keyVaultLocation')), createObject('value', parameters('location')), createObject('value', parameters('keyVaultLocation')))]",
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[variables('names').keyVault]"
          },
          "principalId": {
            "value": "[parameters('principalId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "12590884552340559535"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "name": {
              "type": "string"
            },
            "principalId": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2022-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": "[if(not(empty(parameters('principalId'))), createArray(createObject('objectId', parameters('principalId'), 'tenantId', subscription().tenantId, 'permissions', createObject('keys', createArray('get', 'list'), 'secrets', createArray('get', 'list', 'set', 'delete'), 'certificates', createArray('get', 'list')))), createArray())]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "uri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2022-07-01').vaultUri]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-openai', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": "[if(empty(parameters('gptDeploymentLocation')), createObject('value', parameters('location')), createObject('value', parameters('gptDeploymentLocation')))]",
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[variables('names').openai]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "createOpenAI": {
            "value": "[parameters('createOpenAI')]"
          },
          "existingOpenAIEndpoint": {
            "value": "[parameters('existingOpenAIEndpoint')]"
          },
          "existingOpenAIKey": {
            "value": "[parameters('existingOpenAIKey')]"
          },
          "openAIApiVersion": {
            "value": "[parameters('openAIApiVersion')]"
          },
          "openAIModelName": {
            "value": "[variables('openAIModelName')]"
          },
          "openAIModelVersion": {
            "value": "[variables('openAIModelVersion')]"
          },
          "modelCapacity": {
            "value": "[parameters('modelCapacity')]"
          },
          "modelSku": {
            "value": "[parameters('modelSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "17074657464461697179"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "name": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "createOpenAI": {
              "type": "bool"
            },
            "existingOpenAIEndpoint": {
              "type": "string"
            },
            "existingOpenAIKey": {
              "type": "securestring",
              "defaultValue": ""
            },
            "openAIApiVersion": {
              "type": "string"
            },
            "openAIModelName": {
              "type": "string"
            },
            "openAIModelVersion": {
              "type": "string"
            },
            "modelCapacity": {
              "type": "int",
              "defaultValue": 10
            },
            "modelSku": {
              "type": "string"
            }
          },
          "resources": [
            {
              "condition": "[parameters('createOpenAI')]",
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "OpenAI",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "customSubDomainName": "[parameters('name')]",
                "networkAcls": {
                  "defaultAction": "Allow"
                },
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "condition": "[parameters('createOpenAI')]",
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), parameters('openAIModelName'))]",
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('openAIModelName')]",
                  "version": "[if(not(empty(parameters('openAIModelVersion'))), parameters('openAIModelVersion'), null())]"
                },
                "raiPolicyName": "Microsoft.Default"
              },
              "sku": {
                "capacity": "[parameters('modelCapacity')]",
                "name": "[parameters('modelSku')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-endpoint')]",
              "properties": {
                "value": "[if(parameters('createOpenAI'), reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint, parameters('existingOpenAIEndpoint'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-key')]",
              "properties": {
                "value": "[if(parameters('createOpenAI'), listKeys(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').key1, parameters('existingOpenAIKey'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-deployment')]",
              "properties": {
                "value": "[parameters('openAIModelName')]"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-version')]",
              "properties": {
                "value": "[parameters('openAIApiVersion')]"
              }
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[if(parameters('createOpenAI'), reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-05-01').endpoint, parameters('existingOpenAIEndpoint'))]"
            },
            "deploymentName": {
              "type": "string",
              "value": "[parameters('openAIModelName')]"
            },
            "apiVersion": {
              "type": "string",
              "value": "[parameters('openAIApiVersion')]"
            },
            "serviceName": {
              "type": "string",
              "value": "[if(parameters('createOpenAI'), parameters('name'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-cosmos', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": "[if(empty(parameters('cosmosLocation')), createObject('value', parameters('location')), createObject('value', parameters('cosmosLocation')))]",
          "tags": {
            "value": "[variables('tags')]"
          },
          "accountName": {
            "value": "[variables('names').cosmos]"
          },
          "databaseName": {
            "value": "HAIMEDB"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "6422253443753428590"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "accountName": {
              "type": "string"
            },
            "databaseName": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-04-15",
              "name": "[parameters('accountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "MongoDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  },
                  {
                    "name": "EnableMongo"
                  }
                ],
                "apiProperties": {
                  "serverVersion": "4.2"
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('accountName'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-connection-string')]",
              "properties": {
                "value": "[listConnectionStrings(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), '2023-04-15').connectionStrings[0].connectionString]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              ]
            }
          ],
          "outputs": {
            "accountName": {
              "type": "string",
              "value": "[parameters('accountName')]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), '2023-04-15').documentEndpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-storage', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": "[if(empty(parameters('storageLocation')), createObject('value', parameters('location')), createObject('value', parameters('storageLocation')))]",
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[variables('names').storage]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "10563763415814922906"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "name": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "accessTier": "Hot"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'medical-images')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'images')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'reports')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'metricjobs')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'metricresults')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'evaluatorjobs')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', 'evaluatorresults')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'storage-connection-string')]",
              "properties": {
                "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('name'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2022-09-01').keys[0].value)]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "primaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2022-09-01').primaryEndpoints]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-auth', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[format('auth-{0}', variables('uniqueSuffix'))]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "15271158015425670942"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "name": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'auth-client-id')]",
              "properties": {
                "value": "placeholder-will-be-updated-by-script"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'auth-tenant-id')]",
              "properties": {
                "value": "[subscription().tenantId]"
              }
            }
          ],
          "outputs": {
            "clientId": {
              "type": "string",
              "value": "placeholder-will-be-updated-by-script"
            },
            "tenantId": {
              "type": "string",
              "value": "[subscription().tenantId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-functions', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": "[if(empty(parameters('functionsLocation')), createObject('value', parameters('location')), createObject('value', parameters('functionsLocation')))]",
          "tags": {
            "value": "[variables('tags')]"
          },
          "resourceToken": {
            "value": "[variables('uniqueSuffix')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-storage', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-registry', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "openAIEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.endpoint.value]"
          },
          "openAIDeploymentName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.deploymentName.value]"
          },
          "openAIApiVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.apiVersion.value]"
          },
          "dockerImageTag": {
            "value": "[parameters('dockerImageTag')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "259268082649387932"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "resourceToken": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "storageAccountName": {
              "type": "string"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "openAIEndpoint": {
              "type": "string"
            },
            "openAIDeploymentName": {
              "type": "string"
            },
            "openAIApiVersion": {
              "type": "string"
            },
            "dockerImageTag": {
              "type": "string",
              "defaultValue": "latest",
              "metadata": {
                "description": "Docker image tag"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "[format('func-plan-{0}', parameters('resourceToken'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "P0v3",
                "tier": "PremiumV3",
                "family": "Pv3"
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[format('func-metrics-{0}', parameters('resourceToken'))]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'metrics'))]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('func-plan-{0}', parameters('resourceToken')))]",
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}/haime-metrics:{1}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-01-01-preview').loginServer, parameters('dockerImageTag'))]",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2022-09-01').keys[0].value)]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "python"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_URL",
                      "value": "[format('https://{0}', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-01-01-preview').loginServer)]"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-01-01-preview').username]"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
                      "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2023-01-01-preview').passwords[0].value]"
                    },
                    {
                      "name": "AZURE_OPENAI_ENDPOINT",
                      "value": "[parameters('openAIEndpoint')]"
                    },
                    {
                      "name": "AZURE_OPENAI_API_KEY",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=azure-openai-key)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_OPENAI_DEPLOYMENT",
                      "value": "[parameters('openAIDeploymentName')]"
                    },
                    {
                      "name": "AZURE_OPENAI_VERSION",
                      "value": "[parameters('openAIApiVersion')]"
                    }
                  ],
                  "alwaysOn": true,
                  "ftpsState": "Disabled"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('func-plan-{0}', parameters('resourceToken')))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[reference(resourceId('Microsoft.Web/sites', format('func-metrics-{0}', parameters('resourceToken'))), '2022-09-01', 'full').identity.tenantId]",
                    "objectId": "[reference(resourceId('Microsoft.Web/sites', format('func-metrics-{0}', parameters('resourceToken'))), '2022-09-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', format('func-metrics-{0}', parameters('resourceToken')))]"
              ]
            }
          ],
          "outputs": {
            "metricsAppName": {
              "type": "string",
              "value": "[format('func-metrics-{0}', parameters('resourceToken'))]"
            },
            "metricsAppDefaultHostName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', format('func-metrics-{0}', parameters('resourceToken'))), '2022-09-01').defaultHostName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-registry', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-storage', variables('deploymentName')))]"
      ]
    },
    {
      "condition": "[parameters('enableAcs')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-acs', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "tags": {
            "value": "[variables('tags')]"
          },
          "name": {
            "value": "[format('acs-{0}', variables('uniqueSuffix'))]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "dataLocation": {
            "value": "United States"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14323556644126802353"
            }
          },
          "parameters": {
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "name": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "dataLocation": {
              "type": "string",
              "defaultValue": "United States",
              "metadata": {
                "description": "Where ACS stores data (e.g., United States, Europe)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Communication/communicationServices",
              "apiVersion": "2023-04-01",
              "name": "[parameters('name')]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'acs-connection-string')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.Communication/communicationServices', parameters('name')), '2023-04-01').primaryConnectionString]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/communicationServices', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "connectionStringSecretName": {
              "type": "string",
              "value": "acs-connection-string"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-containerapps', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "containerAppsEnvName": {
            "value": "[variables('names').containerAppsEnv]"
          },
          "containerRegistryName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-registry', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-monitoring', variables('deploymentName'))), '2025-04-01').outputs.logAnalyticsWorkspaceName.value]"
          },
          "applicationInsightsName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-monitoring', variables('deploymentName'))), '2025-04-01').outputs.applicationInsightsName.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "authClientId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-auth', variables('deploymentName'))), '2025-04-01').outputs.clientId.value]"
          },
          "apiImageName": {
            "value": "[parameters('apiImageName')]"
          },
          "resourceToken": {
            "value": "[variables('uniqueSuffix')]"
          },
          "webBaseUrl": "[if(not(empty(parameters('webBaseUrl'))), createObject('value', parameters('webBaseUrl')), createObject('value', ''))]",
          "emailFrom": {
            "value": "[parameters('emailFrom')]"
          },
          "emailSmtpHost": {
            "value": "[parameters('emailSmtpHost')]"
          },
          "emailSmtpPort": {
            "value": "[parameters('emailSmtpPort')]"
          },
          "emailSmtpUser": {
            "value": "[parameters('emailSmtpUser')]"
          },
          "emailSmtpPass": {
            "value": "[parameters('emailSmtpPass')]"
          },
          "emailSmtpUseSsl": {
            "value": "[parameters('emailSmtpUseSsl')]"
          },
          "acsKeyVaultSecretName": "[if(parameters('enableAcs'), createObject('value', 'acs-connection-string'), createObject('value', ''))]",
          "emailEnabled": {
            "value": "[parameters('emailEnabled')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14266777634361074476"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "containerAppsEnvName": {
              "type": "string"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "applicationInsightsName": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "authClientId": {
              "type": "string"
            },
            "apiImageName": {
              "type": "string"
            },
            "resourceToken": {
              "type": "string"
            },
            "webBaseUrl": {
              "type": "string",
              "defaultValue": ""
            },
            "emailFrom": {
              "type": "string",
              "defaultValue": "no-reply@haime.local"
            },
            "emailSmtpHost": {
              "type": "string",
              "defaultValue": ""
            },
            "emailSmtpPort": {
              "type": "int",
              "defaultValue": 587
            },
            "emailSmtpUser": {
              "type": "string",
              "defaultValue": ""
            },
            "emailSmtpPass": {
              "type": "securestring",
              "defaultValue": ""
            },
            "emailSmtpUseSsl": {
              "type": "bool",
              "defaultValue": true
            },
            "acsKeyVaultSecretName": {
              "type": "string",
              "defaultValue": ""
            },
            "emailEnabled": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2023-05-01",
              "name": "[parameters('containerAppsEnvName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2021-12-01-preview').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2021-12-01-preview').primarySharedKey]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2023-05-01",
              "name": "[format('api-{0}', parameters('resourceToken'))]",
              "location": "[parameters('location')]",
              "tags": "[union(parameters('tags'), createObject('azd-service-name', 'api'))]",
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvName'))]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": true,
                    "targetPort": 8080,
                    "corsPolicy": {
                      "allowedOrigins": [
                        "*"
                      ],
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "OPTIONS"
                      ],
                      "allowedHeaders": [
                        "*"
                      ]
                    }
                  },
                  "registries": [
                    {
                      "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2021-09-01').loginServer]",
                      "username": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2021-09-01').username]",
                      "passwordSecretRef": "container-registry-password"
                    }
                  ],
                  "secrets": "[concat(createArray(createObject('name', 'container-registry-password', 'value', listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')), '2021-09-01').passwords[0].value), createObject('name', 'cosmos-connection-string', 'keyVaultUrl', format('{0}secrets/cosmos-connection-string', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri), 'identity', 'system'), createObject('name', 'storage-connection-string', 'keyVaultUrl', format('{0}secrets/storage-connection-string', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri), 'identity', 'system'), createObject('name', 'auth-client-id', 'keyVaultUrl', format('{0}secrets/auth-client-id', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri), 'identity', 'system')), if(empty(parameters('emailSmtpPass')), createArray(), createArray(createObject('name', 'email-smtp-password', 'value', parameters('emailSmtpPass')))), if(empty(parameters('acsKeyVaultSecretName')), createArray(), createArray(createObject('name', 'acs-connection-string', 'keyVaultUrl', format('{0}secrets/{1}', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2022-07-01').vaultUri, parameters('acsKeyVaultSecretName')), 'identity', 'system'))))]"
                },
                "template": {
                  "containers": [
                    {
                      "image": "[if(not(empty(parameters('apiImageName'))), parameters('apiImageName'), 'mcr.microsoft.com/dotnet/aspnet:8.0')]",
                      "name": "api",
                      "env": "[concat(createArray(createObject('name', 'ASPNETCORE_ENVIRONMENT', 'value', 'Production'), createObject('name', 'ASPNETCORE_URLS', 'value', 'http://+:8080'), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', reference(resourceId('Microsoft.Insights/components', parameters('applicationInsightsName')), '2020-02-02').ConnectionString), createObject('name', 'CosmosDb__ConnectionString', 'secretRef', 'cosmos-connection-string'), createObject('name', 'CosmosDb__DatabaseName', 'value', 'HAIMEDB'), createObject('name', 'CosmosDb__ContainerName', 'value', 'Users'), createObject('name', 'COSMOSDB_CONNECTION_STRING', 'secretRef', 'cosmos-connection-string'), createObject('name', 'Storage__ConnectionString', 'secretRef', 'storage-connection-string'), createObject('name', 'AZURE_STORAGE_CONNECTION_STRING', 'secretRef', 'storage-connection-string'), createObject('name', 'AzureStorage__ImageContainer', 'value', 'images'), createObject('name', 'AzureAd__ClientId', 'secretRef', 'auth-client-id'), createObject('name', 'AzureAd__Audience', 'value', parameters('authClientId')), createObject('name', 'AzureAd__TenantId', 'value', subscription().tenantId), createObject('name', 'Email__Smtp__Port', 'value', string(parameters('emailSmtpPort'))), createObject('name', 'Email__Smtp__UseSsl', 'value', string(parameters('emailSmtpUseSsl')))), if(empty(parameters('webBaseUrl')), createArray(), createArray(createObject('name', 'Web__BaseUrl', 'value', parameters('webBaseUrl')))), createArray(createObject('name', 'Email__Enabled', 'value', string(parameters('emailEnabled')))), if(empty(parameters('acsKeyVaultSecretName')), createArray(), createArray(createObject('name', 'Email__Acs__ConnectionString', 'secretRef', 'acs-connection-string'))), if(empty(parameters('emailFrom')), createArray(), createArray(createObject('name', 'Email__From', 'value', parameters('emailFrom')))), if(empty(parameters('emailSmtpHost')), createArray(), createArray(createObject('name', 'Email__Smtp__Host', 'value', parameters('emailSmtpHost')))), if(empty(parameters('emailSmtpUser')), createArray(), createArray(createObject('name', 'Email__Smtp__User', 'value', parameters('emailSmtpUser')))), if(empty(parameters('emailSmtpPass')), createArray(), createArray(createObject('name', 'Email__Smtp__Pass', 'secretRef', 'email-smtp-password'))))]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1Gi"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": 0,
                    "maxReplicas": 3
                  }
                }
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('containerAppsEnvName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[reference(resourceId('Microsoft.App/containerApps', format('api-{0}', parameters('resourceToken'))), '2023-05-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', format('api-{0}', parameters('resourceToken')))]"
              ]
            }
          ],
          "outputs": {
            "apiUri": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', format('api-{0}', parameters('resourceToken'))), '2023-05-01').configuration.ingress.fqdn)]"
            },
            "apiName": {
              "type": "string",
              "value": "[format('api-{0}', parameters('resourceToken'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-auth', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-monitoring', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-registry', variables('deploymentName')))]"
      ]
    },
    {
      "condition": "[parameters('enableEvaluatorAddon')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('{0}-evaluator-addon', variables('deploymentName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "resourceToken": {
            "value": "[variables('uniqueSuffix')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-storage', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
          },
          "azureOpenAIEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.endpoint.value]"
          },
          "azureOpenAIDeployment": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.deploymentName.value]"
          },
          "azureOpenAIVersion": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.apiVersion.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "12176862948215903000"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "environmentName": {
              "type": "string",
              "defaultValue": "haime",
              "metadata": {
                "description": "Base name for resources"
              }
            },
            "resourceToken": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Resource token for unique naming"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name for secrets access"
              }
            },
            "evaluatorAppName": {
              "type": "string",
              "defaultValue": "[format('func-evaluator-{0}', parameters('resourceToken'))]",
              "metadata": {
                "description": "Summary evaluator function app name"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "azureOpenAIEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure OpenAI endpoint for summary evaluator"
              }
            },
            "azureOpenAIKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Azure OpenAI API key for summary evaluator"
              }
            },
            "azureOpenAIDeployment": {
              "type": "string",
              "defaultValue": "gpt-4",
              "metadata": {
                "description": "Azure OpenAI deployment name for summary evaluator"
              }
            },
            "azureOpenAIVersion": {
              "type": "string",
              "defaultValue": "2024-02-01",
              "metadata": {
                "description": "Azure OpenAI API version for summary evaluator"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2022-09-01",
              "name": "[format('plan-evaluator-{0}', parameters('resourceToken'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "P0v3",
                "tier": "PremiumV3",
                "family": "Pv3"
              },
              "kind": "linux",
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('evaluatorAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp,linux",
              "tags": {
                "azd-service-name": "evaluator"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-evaluator-{0}', parameters('resourceToken')))]",
                "siteConfig": {
                  "linuxFxVersion": "Python|3.11",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix=core.windows.net', parameters('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2022-09-01').keys[0].value)]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "python"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    },
                    {
                      "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                      "value": "true"
                    },
                    {
                      "name": "AZURE_OPENAI_ENDPOINT",
                      "value": "[parameters('azureOpenAIEndpoint')]"
                    },
                    {
                      "name": "AZURE_OPENAI_API_KEY",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=azure-openai-key)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_OPENAI_DEPLOYMENT",
                      "value": "[parameters('azureOpenAIDeployment')]"
                    },
                    {
                      "name": "AZURE_OPENAI_VERSION",
                      "value": "[parameters('azureOpenAIVersion')]"
                    }
                  ],
                  "alwaysOn": true,
                  "ftpsState": "Disabled"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-evaluator-{0}', parameters('resourceToken')))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2022-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'add')]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[reference(resourceId('Microsoft.Web/sites', parameters('evaluatorAppName')), '2022-09-01', 'full').identity.tenantId]",
                    "objectId": "[reference(resourceId('Microsoft.Web/sites', parameters('evaluatorAppName')), '2022-09-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('evaluatorAppName'))]"
              ]
            }
          ],
          "outputs": {
            "evaluatorAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the summary evaluator function app"
              },
              "value": "[parameters('evaluatorAppName')]"
            },
            "evaluatorAppDefaultHostName": {
              "type": "string",
              "metadata": {
                "description": "Default hostname of the summary evaluator function app"
              },
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('evaluatorAppName')), '2022-09-01').defaultHostName]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-functions', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-storage', variables('deploymentName')))]"
      ]
    }
  ],
  "outputs": {
    "AZURE_LOCATION": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "AZURE_TENANT_ID": {
      "type": "string",
      "value": "[tenant().tenantId]"
    },
    "AZURE_RESOURCE_GROUP_NAME": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-registry', variables('deploymentName'))), '2025-04-01').outputs.loginServer.value]"
    },
    "AZURE_CONTAINER_REGISTRY_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-registry', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
    },
    "AZURE_KEY_VAULT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-keyvault', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
    },
    "COSMOS_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-cosmos', variables('deploymentName'))), '2025-04-01').outputs.accountName.value]"
    },
    "STORAGE_ACCOUNT_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-storage', variables('deploymentName'))), '2025-04-01').outputs.name.value]"
    },
    "AUTH_CLIENT_ID": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-auth', variables('deploymentName'))), '2025-04-01').outputs.clientId.value]"
    },
    "API_BASE_URL": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-containerapps', variables('deploymentName'))), '2025-04-01').outputs.apiUri.value]"
    },
    "WEB_BASE_URL": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-containerapps', variables('deploymentName'))), '2025-04-01').outputs.apiUri.value]"
    },
    "METRICS_FUNCTION_APP_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-functions', variables('deploymentName'))), '2025-04-01').outputs.metricsAppName.value]"
    },
    "METRICS_FUNCTION_APP_URL": {
      "type": "string",
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', format('{0}-functions', variables('deploymentName'))), '2025-04-01').outputs.metricsAppDefaultHostName.value)]"
    },
    "EVALUATOR_FUNCTION_APP_NAME": {
      "type": "string",
      "value": "[if(parameters('enableEvaluatorAddon'), reference(resourceId('Microsoft.Resources/deployments', format('{0}-evaluator-addon', variables('deploymentName'))), '2025-04-01').outputs.evaluatorAppName.value, '')]"
    },
    "EVALUATOR_FUNCTION_APP_URL": {
      "type": "string",
      "value": "[if(parameters('enableEvaluatorAddon'), format('https://{0}', reference(resourceId('Microsoft.Resources/deployments', format('{0}-evaluator-addon', variables('deploymentName'))), '2025-04-01').outputs.evaluatorAppDefaultHostName.value), '')]"
    },
    "AZURE_OPENAI_ENDPOINT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.endpoint.value]"
    },
    "AZURE_OPENAI_DEPLOYMENT": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.deploymentName.value]"
    },
    "AZURE_OPENAI_SERVICE_NAME": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-openai', variables('deploymentName'))), '2025-04-01').outputs.serviceName.value]"
    }
  }
}