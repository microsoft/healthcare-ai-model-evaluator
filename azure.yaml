name: healthcare-ai-model-evaluator
metadata:
  # For traceability this is also set as a tag on all resources created. See infra/main.bicep
  template: healthcare-ai-model-evaluator@0.0.1

services:
  api:
    project: ./backend/src/MedBench.API
    language: dotnet
    host: containerapp
    hooks:
      prebuild:
        posix:
          shell: sh
          run: |
            # Check if environment variables are available before building frontend
            if azd env get-value AUTH_CLIENT_ID >/dev/null 2>&1 && azd env get-value API_BASE_URL >/dev/null 2>&1; then
              echo "Environment variables found - building frontend..."
              cd ../../../frontend
              ../infra/scripts/update-env.sh
              npm install
              npm run build
              # Copy built files to backend wwwroot
              mkdir -p ../backend/src/MedBench.API/wwwroot/webapp
              cp -r build/* ../backend/src/MedBench.API/wwwroot/webapp/
              echo "Frontend build completed"
            else
              echo "Environment variables not yet available - skipping frontend build"
              echo "Frontend will be built after infrastructure is provisioned"
            fi
          interactive: false
          continueOnError: false

  # Main metrics processor function app (Docker-based)
  metrics:
    project: ./functions
    language: python
    host: function
    module: .

  # Summary evaluator addon function app
  evaluator:
    project: ./functions/addons/evaluator/build
    language: python
    host: function
    module: .
    hooks:
      prepackage:
        shell: sh
        run: ../../package_addon.sh evaluator
        continueOnError: false

hooks:
  preprovision:
    - shell: sh
      run: ./infra/hooks/preprovision.sh
      continueOnError: false
  postprovision:
    - run: ./infra/scripts/postprovision.sh
      continueOnError: false

infra:
  provider: bicep
  path: infra
  module: main
  parameters:
    enableWebIpFiltering: "${ENABLE_WEB_IP_FILTERING}"
    allowedWebIp: "${ALLOWED_WEB_IP}"
    authClientId: "${AUTH_CLIENT_ID}"